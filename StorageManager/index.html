<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>StorageManager</title>
  </head>
  <body>
    <button onclick="onBtnCick(this)">点击我哇</button>

    <script>
      async function onBtnCick(e) {
        // 从主线程检索发送到 worker 的消息
        const message = e.data;

        // 获取草稿文件的句柄
        const root = await navigator.storage.getDirectory();
        const draftHandle = await root.getFileHandle("draft.txt", {
          create: true,
        });
        // 获取同步访问句柄
        const accessHandle = await draftHandle.createWritable();

        // 获取文件的大小
        const fileSize = accessHandle.getSize();
        // 将文件内容读取到缓冲区
        const buffer = new DataView(new ArrayBuffer(fileSize));
        const readBuffer = accessHandle.read(buffer, { at: 0 });

        // 将消息写入文件末尾
        const encoder = new TextEncoder();
        const encodedMessage = encoder.encode(message);
        const writeBuffer = accessHandle.write(encodedMessage, {
          at: readBuffer,
        });

        // 将更改保存到磁盘
        accessHandle.flush();

        // 如果完成，请始终关闭 FileSystemSyncAccessHandle
        accessHandle.close();
      }
    </script>
  </body>
</html>
